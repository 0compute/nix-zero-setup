#!/usr/bin/env bash

set -euo pipefail

# {{{ getopt

result=./result
seedAttr=seed
registry=ghcr.io

usage() {
  cat <<EOF
Usage:
  publish IMAGE_NAME COMMIT_SHA
Options:
  --result RESULT
    path to a container tarball (default: $result)
  --seed-attr SEED_ATTR
    name of the seed package attr (default: $seedAttr)
  --registry REGISTRY
    target registry (default: $registry)
  --tag TAG
    add an extra tag such as IMAGE_NAME:latest
Args:
  IMAGE_NAME  repository to push (e.g., ghcr.io/org/nix-seed)
  COMMIT_SHA  git commit SHA for verification
EOF
}

PARSED=$(
  getopt \
    --options '' \
    --long result:,seed-attr:,registry:,tag: \
    -- "$@"
) || {
  usage
  exit 1
}
eval set -- "$PARSED"

tags=()
while true; do
  case "$1" in
  --result)
    result=$2
    shift 2
    ;;
  --seed-attr)
    seedAttr=$2
    shift 2
    ;;
  --registry)
    registry=$2
    shift 2
    ;;
  --tag)
    tags+=("$2")
    shift 2
    ;;
  *)
    usage
    exit 1
    ;;
  esac
done

if [[ $# -ne 2 ]]; then
  usage
  exit 1
fi

name=$1
commit=$2
image="$name:$commit"

# identity: tries env vars then falls back to user@host
for candidate in BUILDER_IDENTITY GITHUB_ACTOR; do
  value=${!candidate:-}
  if [[ -n $value ]]; then
    builderIdentity=$value
    break
  fi
done
if [[ -z ${builderIdentity:-} ]]; then
  builderIdentity=$(whoami)@$(hostname --fqdn)
fi

# }}}

# {{{ sanity check

[[ -e $result ]] || {
  echo >&2 "result path '$result' does not exist"
  exit 1
}
[[ -n ${REGISTRY_USER:-} && -n ${REGISTRY_PASS:-} ]] || {
  echo >&2 "REGISTRY_USER and REGISTRY_PASS must be set"
  exit 1
}

# }}}

# {{{ load/tag/push

result=$(podman load --input "$result" | awk 'NR==1 {print $NF}')
[[ $result =~ :$commit$ ]] || {
  echo >&2 "commit mismatch $result != $commit"
  exit 1
}

podman login \
  --username "$REGISTRY_USER" \
  --password-stdin "$registry" \
  <<<"$REGISTRY_PASS"

# work out if we're on a CI runner
CI=
[[ -z ${GITHUB_SHA:-} ]] || CI=1

# tag and push, for CI do the push in one go
tags+=(
  "$commit"
  "$(git describe --tags --always)"
)
for tag in "${tags[@]}"; do
  nametag="$name:$tag"
  podman tag "$result" "$nametag"
  [[ -n $CI ]] || podman push "$nametag"
done
[[ -z $CI ]] || podman push --all-tags "$name"

# }}}

# {{{ attest

system=$(nix eval --raw ".#$seedAttr.system")

predicate="./$commit.$system.json"

cat <<EOF >"$predicate"
{
  "schemaVersion": 1,
  "predicateType": "https://github.com/0compute/nix-seed",
  "timestamp": "$(date --utc +'%Y-%m-%dT%H:%M:%SZ')",
  "system": "$system",
  "gitHash": "$commit",
  "narHash": "$(
  nix path-info --json --json-format 1 "$result" | jq --raw-output '.[].narHash'
)",
  # TODO: look in ./result json for this
  # XXX: redundant with
  "imageHash": "$(podman inspect --format='{{index .RepoDigests 0}}' "$image")",
  "registry": "$registry",
  "layerHashes": $(
  tar --extract --file "$result" --to-stdout manifest.json |
    jq --raw-output '.[0].Layers | map(split("/")[0]) | @json'
),
  "tags": $(
  printf '%s\n' "${tags[@]}" | jq --raw-input '.' | jq --slurp '.'
),
  "builder": {
    "identity": "$builderIdentity",
    "actor": "${GITHUB_ACTOR:-}",
    "repository": "${GITHUB_REPOSITORY:-}",
    "workflow": "${GITHUB_WORKFLOW:-}",
    "runId": "${GITHUB_RUN_ID:-}",
    "event": "${GITHUB_EVENT_NAME:-}",
    "ref": "${GITHUB_REF:-}"
  }
}
EOF

echo "wrote: $predicate"

cosign attest \
  --rekor-url "$(nix eval --raw .#seedCfg.rekor.url)" \
  --predicate "$predicate" \
  "$image"

cosign upload blob --files=$predicate "$image"

# }}}
