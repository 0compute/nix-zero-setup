#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 <store-path>"
  exit 1
fi

nix path-info --json --json-format 1 --recursive "$1" | jq -r '
  (map({key: .path, value: .references}) | from_entries) as $deps |
  reduce (keys_unsorted[] | select(. != null)) as $p ({};
    def get_depth($node; $visited):
      if .[$node] != null then .
      elif $visited[$node] then . + {($node): 0}
      else
        ($deps[$node] // []) as $refs |
        if ($refs | length) == 0 then . + {($node): 0}
        else
          reduce $refs[] as $r (.; get_depth($r; $visited + {($node): true})) |
          . + {($node): (1 + ([$refs[] | .[.] // 0] | max))}
        end
      end;
    get_depth($p; {})
  ) |
  to_entries |
  group_by(.value) |
  map({depth: .[0].value, count: length}) |
  sort_by(.depth) |
  "Depth | Nodes",
  "------|------",
  (.[] | "\( .depth )" + (" " * (6 - (.depth | tostring | length))) + "| \( .count )")
'
