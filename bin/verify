#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
verify
Verifies an n-of-m attestation quorum and optionally attaches attestations to
an OCI image via oras.

Usage:
  verify IMAGE_REF [-d DIR] [-r N] [-A] [-a] [--arch ARCH] [--os OS] [--dry-run]

Options:
  -d DIR  Directory with *.json attestations (default: attestations)
  -r N    Minimum attestations required (default: 2)
  -A      Attach attestations to IMAGE_REF
  -a      Annotate image with attestation media type via skopeo (implies -A)
  --arch  Target arch for annotation (default: host arch)
  --os    Target os for annotation (default: host os)
  --dry-run  Verify only; do not attach (default)
USAGE
}

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

image_ref=$1
shift

attest_dir=attestations
required=2
attach=false
annotate=false
dry_run=false
arch=$(uname -m)
os=$(uname -s | tr 'A-Z' 'a-z')

while (("$#")); do
  case "$1" in
  -d)
    attest_dir=$2
    shift 2
    ;;
  -r)
    required=$2
    shift 2
    ;;
  -A)
    attach=true
    shift
    ;;
  -a)
    attach=true
    annotate=true
    shift
    ;;
  --arch)
    arch=$2
    shift 2
    ;;
  --os)
    os=$2
    shift 2
    ;;
  --dry-run)
    dry_run=true
    shift
    ;;
  *)
    usage
    exit 1
    ;;
  esac
done

command -v jq >/dev/null
command -v oras >/dev/null
if [[ ${annotate} == true ]]; then
  command -v skopeo >/dev/null
fi

if [[ ! -d ${attest_dir} ]]; then
  echo "attestations dir missing: ${attest_dir}" >&2
  exit 1
fi

shopt -s nullglob
files=("${attest_dir}"/*.json)
shopt -u nullglob

if [[ ${#files[@]} -lt ${required} ]]; then
  echo "insufficient attestations: found ${#files[@]}, need ${required}" >&2
  exit 1
fi

digest_count=$(jq -r '.containerDigest' "${files[@]}" | sort -u | wc -l)
if [[ ${digest_count} -ne 1 ]]; then
  echo "digest mismatch across attestations" >&2
  exit 1
fi

digest=$(jq -r '.containerDigest' "${files[@]}" | head -1)
echo "verified ${#files[@]} attestations for ${digest}"

if [[ ${attach} != true ]] || [[ ${dry_run} == true ]]; then
  echo "attach skipped"
  exit 0
fi

for f in "${files[@]}"; do
  oras attach \
    --artifact-type application/vnd.in-toto+json \
    "${image_ref}" \
    "${f}:application/json"
done

if [[ ${annotate} == true ]]; then
  args=(
    --format oci
    --add-annotation org.opencontainers.image.attestation=application/json
  )
  for pair in "arch:${arch}" "os:${os}"; do
    key=${pair%%:*}
    value=${pair#*:}
    if [[ -n ${value} ]]; then
      args+=(--override-"${key}" "${value}")
    fi
  done
  skopeo copy "${args[@]}" "${image_ref}" "docker://${image_ref}"
fi
