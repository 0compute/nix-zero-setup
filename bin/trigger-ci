#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: trigger-ci --provider gitlab|circleci|appveyor --repo OWNER/REPO --ref REF --sha SHA [--gitlab-project-id ID] [--appveyor-account ACCOUNT] [--appveyor-slug SLUG]

Environment:
  GITLAB_TRIGGER_TOKEN   GitLab trigger token (gitlab provider)
  CIRCLECI_TOKEN         CircleCI API token (circleci provider)
  APPVEYOR_TOKEN         AppVeyor API token (appveyor provider)

Examples:
  trigger-ci --provider gitlab --repo org/proj --ref main --sha $GITHUB_SHA --gitlab-project-id 12345
  trigger-ci --provider circleci --repo org/proj --ref main --sha $GITHUB_SHA
  trigger-ci --provider appveyor --repo org/proj --ref main --sha $GITHUB_SHA --appveyor-account org --appveyor-slug proj
EOF
}

provider=""
repo=""
ref=""
sha=""
gitlab_project_id=""
appveyor_account=""
appveyor_slug=""

while [ $# -gt 0 ]; do
  case "$1" in
  --provider)
    provider="$2"
    shift 2
    ;;
  --repo)
    repo="$2"
    shift 2
    ;;
  --ref)
    ref="$2"
    shift 2
    ;;
  --sha)
    sha="$2"
    shift 2
    ;;
  --gitlab-project-id)
    gitlab_project_id="$2"
    shift 2
    ;;
  --appveyor-account)
    appveyor_account="$2"
    shift 2
    ;;
  --appveyor-slug)
    appveyor_slug="$2"
    shift 2
    ;;
  -h | --help)
    usage
    exit 0
    ;;
  *)
    echo "Unknown argument: $1" >&2
    usage >&2
    exit 1
    ;;
  esac
done

if [ -z "$provider" ] || [ -z "$repo" ] || [ -z "$ref" ] || [ -z "$sha" ]; then
  usage >&2
  exit 1
fi

case "$provider" in
gitlab)
  if [ -z "${GITLAB_TRIGGER_TOKEN-}" ] || [ -z "$gitlab_project_id" ]; then
    echo "gitlab requires GITLAB_TRIGGER_TOKEN and --gitlab-project-id" >&2
    exit 1
  fi
  curl --fail --show-error --request POST \
    "https://gitlab.com/api/v4/projects/${gitlab_project_id}/trigger/pipeline" \
    --form "token=${GITLAB_TRIGGER_TOKEN}" \
    --form "ref=${ref}" \
    --form "variables[SHA]=${sha}" \
    --form "variables[REPO]=${repo}"
  ;;
circleci)
  if [ -z "${CIRCLECI_TOKEN-}" ]; then
    echo "circleci requires CIRCLECI_TOKEN" >&2
    exit 1
  fi
  curl --fail --show-error --request POST \
    --url "https://circleci.com/api/v2/project/gh/${repo}/pipeline" \
    --header "Circle-Token: ${CIRCLECI_TOKEN}" \
    --header "Content-Type: application/json" \
    --data @- <<EOF
{"branch":"${ref}","parameters":{"sha":"${sha}"}}
EOF
  ;;
appveyor)
  if [ -z "${APPVEYOR_TOKEN-}" ] || [ -z "$appveyor_account" ] || [ -z "$appveyor_slug" ]; then
    echo "appveyor requires APPVEYOR_TOKEN, --appveyor-account, and --appveyor-slug" >&2
    exit 1
  fi
  curl --fail --show-error --request POST \
    --url "https://ci.appveyor.com/api/builds" \
    --header "Authorization: Bearer ${APPVEYOR_TOKEN}" \
    --header "Content-Type: application/json" \
    --data @- <<EOF
{"accountName":"${appveyor_account}","projectSlug":"${appveyor_slug}","branch":"${ref}","commitId":"${sha}"}
EOF
  ;;
*)
  echo "Unsupported provider: $provider" >&2
  exit 1
  ;;
esac
